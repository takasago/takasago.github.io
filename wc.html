<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<meta name="robots" content="all">
		<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
		<script type="text/javascript" src="./scripts
		/peer.min.0.3.14.js"></script>
		<script type="text/javascript" src="./scripts
		/main.js"></script>
		<link rel="stylesheet" href="./resources/site.css" type="text/css" media="all"></link>
		<title>Webcam</title>
	</head>
	<!--nobanner-->
	<body id="top">
		<header>
			<h1><a href="./wc.html">Webcam</a></h1>
		</header>

		<div id="contents">
			<section id="dialer">
				<dl>
					<dt>Your ID</dt>
						<dd><span id="peer-id"></span></dd>
					<dt>Remote ID</dt>
						<dd><input type="text" id="remote-peer-id" placeholder="Input remote ID."></input>&nbsp;<button id="call" onClick="callTo($('#remote-peer-id').val());">Call</button></dd>
				</dl>
			</section>
			<section id="controller">
				<ul>
					<li><button type="button" onclick="startVideo();">▶</button></li>
					<li><button type="button" onclick="stopVideo();">■</button></li>
				</ul>
			</section>
			<section id="camera">
   			<img id="color_bar" src="./resources/color_bar.jpg"></img>
				<video id="local_video" muted autoplay></video>
				<video id="remote_video" autoplay></video>
			</section>
		</div>

		<footer id="site_footer">
			<p id="copyright">Copyright &copy; <a href="http://backspace.jp/" target="_blank">Backspace Dev-Team</a>, 2017-. All rights reserved.</p>
		</footer>
  </body>
  <script type="text/javascript">
    let localVideo = document.getElementById('local_video');
    let remoteVideo = document.getElementById('remote_video');
    let localStream = null;
    
    navigator.getUserMedia	= navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;

    var id = getRandomString();
    var rid = null;
    var query = getUrlVars();
    if ('id' in query) {
      id = query['id'];
    }
    var peer = new Peer(id, {key: 'peerjs', host: 'v2.backspace.jp', port: 9000, path: '/peerjs'});
    
    peer.on('open', function(id){
    	$('#peer-id').text(id);
      // console.log(id);
    });
    peer.on('close', function(){
      console.log('main().peer.on; close');
    });
    peer.on('connection', function(call){
      console.log('main().peer.on; connection');
    });
    peer.on('disconnected', function(call){
      console.log('main().peer.on; disconnected');
    });
    peer.on('call', function(call){
      if (localStream == null) {
       	call.answer();
      } else {
       	call.answer(localStream);
      }
      console.log('main().peer.on: call answer; ' + call.id);
      call.on('stream', function(othersStream){
    		$('#remote_video').prop('src', URL.createObjectURL(othersStream));
    	});
    	call.on('error', function(error){
      	console.error('main().call.on error:', error);
      	return;
    	});
    });
    peer.on('error', function(error){
    	console.error('main().peer.on error:', error);
    	return;
    });

    if ('rid' in query) {
      rid = query['rid'];
      console.log('main(): rid; ' + rid);
    	$('#remote-peer-id').val(rid);
    }

    if (startVideo()) {
      if ($('#remote-peer-id').val() != '') {
        $('#call').trigger('click');
      }
    }
  </script>
</html>
